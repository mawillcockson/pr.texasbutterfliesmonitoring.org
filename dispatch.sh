#!/bin/sh
set -eu
# To use this script, the following environment variables must be set
# - RENDER_REPOSITORY_TOKEN
# A personal access token with a scope "public_repo".
# Generate one here
# https://github.com/settings/tokens/new
# This token should be generated by a user with the ability to trigger
# workflow_dispatch events in the RENDER_REPOSITORY.
#
# - RENDER_REPOSITORY_TOKEN_USER
# The user the RENDER_REPOSITORY_TOKEN was generated by
#
# Additionally, these can be overridden by setting them in the calling
# environment
#
# The pull request number to request a preview of
PULL_REQUEST_ID="${PULL_REQUEST_ID:-"1"}"
export PULL_REQUEST_ID
# The full payload of the github event
# Pull Request payload example:
# https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#pull_request
GITHUB_EVENT="${GITHUB_EVENT:-"$(jq --null-input --compact-output '{
    "action": "opened",
    "number": (env.PULL_REQUEST_ID),
    "pull_request": {
        "html_url": ("https://github.com/mawillcockson/TXButterflies.github.io/pull/" + env.PULL_REQUEST_ID),
        "number": (env.PULL_REQUEST_ID),
    },
}')"}"
export GITHUB_EVENT
# A git reference
# More info:
# https://docs.github.com/en/rest/reference/actions#create-a-workflow-dispatch-event
# This is required, but the renderer doesn't currently use it
GITHUB_REF="${GITHUB_REF:-"main"}"
export GITHUB_REF
# The username/repository of the GitHub repository that hosts the renderer
# workflow
RENDER_REPOSITORY="${RENDER_REPOSITORY:-"mawillcockson/pr.texasbutterfliesmonitoring.org"}"
export RENDER_REPOSITORY


TEMP_FILE="$(mktemp)"
export TEMP_FILE

printf '%s' "${GITHUB_EVENT}" \
| jq --compact-output '{
    "ref": (env.GITHUB_REF),
    "inputs": {
        "pull_request_id": (.pull_request.number),
        "pull_request_event": (. | @json)
    }
}' \
> "${TEMP_FILE}"

curl \
    --request POST \
    --header "Accept: application/vnd.github.v3+json" \
    --user "${RENDER_REPOSITORY_TOKEN_USER}:${RENDER_REPOSITORY_TOKEN}" \
    --post301 --post302 --post303 \
    --data "@${TEMP_FILE}" \
    --url "https://api.github.com/repos/${RENDER_REPOSITORY}/actions/workflows/pull_request.yaml/dispatches"

rm "${TEMP_FILE}"
